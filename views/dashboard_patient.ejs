<%- include('partials/header') %>

<div class="page-container">
  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success">
      <strong>Done:</strong>
      <span><%= success %></span>
    </div>
  <% } %>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <strong>Cannot complete action:</strong>
      <span><%= error %></span>
    </div>
  <% } %>

<%- include('partials/flash') %>

  <section class="dashboard-grid">
    <div class="card">
      <div class="card-inner">
        <h1 class="page-title">Your health schedule</h1>
        <p class="page-subtitle">
          Keep track of your upcoming visits with Nirnoy doctors.
        </p>

        <% if (nextAppointment) { %>
          <div class="next-appt-card">
            <div class="next-appt-label">Next appointment</div>
            <div class="next-appt-main">
              <div class="next-appt-row">
                <div class="next-appt-doc">
                  <div class="next-appt-doc-name">
                    <%= nextAppointment.doctor_name || 'Doctor' %>
                  </div>
                  <% if (nextAppointment.clinic_name) { %>
                    <div class="next-appt-clinic">
                      <%= nextAppointment.clinic_name %>
                      <% if (nextAppointment.clinic_area) { %>
                        · <%= nextAppointment.clinic_area %>
                      <% } %>
                    </div>
                  <% } %>
                </div>
                <div class="next-appt-tag">
                  <span class="badge-status badge-status-booked">
                    <%= (nextAppointment.status || 'booked').toLowerCase() %>
                  </span>
                </div>
              </div>
              <div class="next-appt-when">
                <div class="next-appt-date">
                  <%= nextAppointment.appt_date || '' %>
                </div>
                <% if (nextAppointment.slot_time) { %>
                  <div class="next-appt-time">
                    at <%= nextAppointment.slot_time %>
                  </div>
                <% } %>
              </div>
            </div>
            <div class="next-appt-actions">
              <a
                href="/patient/appointments/<%= nextAppointment.id %>"
                class="btn btn-primary btn-sm"
              >
                Visit details
              </a>

              <a
                href="/patient/appointments"
                class="btn btn-ghost btn-sm"
              >
                All visits
              </a>
            </div>
          </div>
        <% } else { %>
          <div class="card-muted-message">
            You don’t have any upcoming appointments yet.
            <br>
            Browse the <a href="/doctors">doctor directory</a> to book your first visit.
          </div>
        <% } %>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="card">
      <div class="card-inner">
        <div class="section-header">
          <h2 class="section-title">My doctors</h2>
        </div>

        <% if (!myDoctors || !myDoctors.length) { %>
          <p class="muted">
            You have not visited any doctors through Nirnoy yet.
          </p>
        <% } else { %>
          <div class="mydoctors-list">
            <% myDoctors.forEach(function (doc) { %>
              <div class="mydoc-row">
                <div class="mydoc-main">
                  <div class="mydoc-name">
                    <strong><%= doc.doctor_name || 'Doctor' %></strong>
                  </div>

                  <div class="mydoc-meta">
                    <%= doc.doctor_specialty || 'Specialty not specified' %>
                    <% if (doc.doctor_area) { %>
                      · <%= doc.doctor_area %>
                    <% } %>
                  </div>

                  <% if (doc.last_visit_date) { %>
                    <div class="mydoc-last">
                      Last visit: <%= doc.last_visit_date %>
                    </div>
                  <% } %>
                </div>

                <div class="mydoc-actions">
                  <a
                    href="/doctors/<%= doc.doctor_id %>"
                    class="btn btn-ghost btn-sm"
                  >
                    View doctor
                  </a>

                  <a
                    href="/bookings/new?doctor_id=<%= doc.doctor_id %>"
                    class="btn btn-primary btn-sm"
                  >
                    Book again
                  </a>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="card">
      <div class="card-inner">
        <div class="section-header">
          <h2 class="section-title">Upcoming visits</h2>
        </div>

        <% if (!upcomingAppointments || !upcomingAppointments.length) { %>
          <p class="muted">No upcoming visits yet.</p>
        <% } else { %>
          <div class="visit-list">
            <% upcomingAppointments.forEach(function (appt) { %>
              <div class="visit-row">
                <div class="visit-main">
                  <div class="visit-doc">
                    <strong><%= appt.doctor_name || 'Doctor' %></strong>
                  </div>
                  <% if (appt.clinic_name) { %>
                    <div class="visit-clinic">
                      <%= appt.clinic_name %>
                      <% if (appt.clinic_area) { %>
                        · <%= appt.clinic_area %>
                      <% } %>
                    </div>
                  <% } %>
                  <div class="visit-when">
                    <%= appt.appt_date || '' %>
                    <% if (appt.slot_time) { %>
                      · <%= appt.slot_time %>
                    <% } %>
                  </div>
                </div>
                <div class="visit-meta">
                  <%
                    const stUpcoming = (appt.status || 'booked').toLowerCase();
                    let badgeClassUpcoming = 'badge-status-booked';
                    if (stUpcoming === 'completed') badgeClassUpcoming = 'badge-status-completed';
                    else if (stUpcoming === 'cancelled') badgeClassUpcoming = 'badge-status-cancelled';
                  %>
                  <span class="badge-status <%= badgeClassUpcoming %>">
                    <%= stUpcoming %>
                  </span>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="card">
      <div class="card-inner">
        <div class="section-header">
          <h2 class="section-title">Past visits</h2>
        </div>

        <% if (!pastAppointments || !pastAppointments.length) { %>
          <p class="muted">No past visits recorded yet.</p>
        <% } else { %>
          <div class="visit-list">
            <% pastAppointments.forEach(function (appt) { %>
              <div class="visit-row">
                <div class="visit-main">
                  <div class="visit-doc">
                    <strong><%= appt.doctor_name || 'Doctor' %></strong>
                  </div>
                  <% if (appt.clinic_name) { %>
                    <div class="visit-clinic">
                      <%= appt.clinic_name %>
                      <% if (appt.clinic_area) { %>
                        · <%= appt.clinic_area %>
                      <% } %>
                    </div>
                  <% } %>
                  <div class="visit-when">
                    <%= appt.appt_date || '' %>
                    <% if (appt.slot_time) { %>
                      · <%= appt.slot_time %>
                    <% } %>
                  </div>
                </div>
                <div class="visit-meta">
                  <%
                    const stPast = (appt.status || '').toLowerCase();
                    let badgeClassPast = 'badge-status-other';
                    if (stPast === 'booked' || stPast === 'upcoming') badgeClassPast = 'badge-status-booked';
                    else if (stPast === 'completed') badgeClassPast = 'badge-status-completed';
                    else if (stPast === 'cancelled') badgeClassPast = 'badge-status-cancelled';
                  %>
                  <span class="badge-status <%= badgeClassPast %>">
                    <%= stPast || 'n/a' %>
                  </span>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>
</div>

<%- include('partials/footer') %>
