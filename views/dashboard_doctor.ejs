<%- include('partials/header') %>
<%- include('partials/flash') %>

<% function renderDashboardBody() { %>
  <section class="doctor-dashboard">
    <div class="wrap">
      <header class="page-header">
        <p class="eyebrow">Doctor</p>
        <h1>Today’s queue</h1>
        <p class="page-subtitle">
          See who is waiting today and how far behind you are.
        </p>
      </header>

      <section class="doctor-stats">
        <div class="stats-grid">
          <div class="card stat-card">
            <p class="stat-label">Today’s patients</p>
            <p class="stat-value"><%= (stats && stats.totalToday) || 0 %></p>
          </div>
          <div class="card stat-card">
            <p class="stat-label">Finished today</p>
            <p class="stat-value"><%= (stats && stats.doneToday) || 0 %></p>
          </div>
          <div class="card stat-card">
            <p class="stat-label">Total unique patients</p>
            <p class="stat-value"><%= (stats && stats.totalUniquePatients) || 0 %></p>
          </div>
        </div>
      </section>

      <section class="doctor-settings">
        <div class="card doctor-settings__card">
          <h3>Visit settings</h3>
          <p>Visit duration (min): <strong><%= visitDuration %></strong></p>
          <form method="post" action="/doctor/running-late" class="doctor-settings__form">
            <%- include('partials/csrf') %>
            <label>Running late (+min)</label>
            <input type="number" name="minutes" value="<%= runningLateMinutes %>" min="0">
            <button class="btn primary btn-xs">Save</button>
          </form>
        </div>
      </section>

      <section class="queue-section">
        <% if (!appointments || !appointments.length) { %>
          <p class="empty">No patients booked for today yet.</p>
        <% } else { %>
          <table class="queue-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Time</th>
                <th>Clinic</th>
                <th>Patient</th>
                <th>Status</th>
                <th>ETA</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% appointments.forEach(a => { %>
                <tr class="queue-row queue-row--<%= (a.status || 'pending').toLowerCase() %>">
                  <td><%= (typeof a.position === 'number') ? a.position : '-' %></td>
                  <td><%= a.slot_time || '' %></td>
                  <td><%= a.clinic_name || '' %></td>
                  <td><%= a.patient_name || '' %></td>
                  <td><%= a.status || 'pending' %></td>
                  <td>
                    <% if (typeof a.etaMinutes === 'number') { %>
                      ~<%= a.etaMinutes %> min
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                  <td class="queue-actions">
                    <a href="/appointments/<%= a.id %>" class="btn ghost btn-xs">Details</a>
                    <a href="/doctor/appointments/<%= a.id %>/edit" class="btn primary btn-xs">Visit</a>
                    <form method="post" action="/doctor/appointments/<%= a.id %>/call" class="inline-form">
                      <%- include('partials/csrf') %>
                      <button class="btn ghost btn-xs" type="submit">Call</button>
                    </form>
                    <form method="post" action="/doctor/appointments/<%= a.id %>/start" class="inline-form">
                      <%- include('partials/csrf') %>
                      <button class="btn ghost btn-xs" type="submit">Start</button>
                    </form>
                    <form method="post" action="/doctor/appointments/<%= a.id %>/done" class="inline-form">
                      <%- include('partials/csrf') %>
                      <button class="btn ghost btn-xs" type="submit">Done</button>
                    </form>
                    <form method="post" action="/doctor/appointments/<%= a.id %>/noshow" class="inline-form">
                      <%- include('partials/csrf') %>
                      <button class="btn ghost btn-xs" type="submit">No-show</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>
    </div>
  </section>
<% } %>

<%- include('partials/dashboard_shell') %>

<%- include('_footer') %>
