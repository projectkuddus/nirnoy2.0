<!doctype html><html><body>
<%- include('_header') %><%- include('_flash') %>
<div class="wrap">
  <h2>Files â€” <%= a.appt_date %> <%= a.slot_time %></h2>
  <div class="row">
    <div class="card" style="flex:1 1 420px">
      <h3>Upload (PDF/JPG/PNG)</h3>
      <form method="post" action="/appointments/<%= a.id %>/upload" enctype="multipart/form-data">
        <%- include('partials/csrf') %>
        <p><input type="file" name="file" required></p>
        <p><input name="note" placeholder="Note (optional)" style="width:100%"></p>
        <p>
          <select name="kind">
            <option value="report">Lab report</option>
            <option value="image">Image</option>
          </select>
        </p>
        <p><button>Upload</button></p>
      </form>
    </div>

    <div class="card" style="flex:2 1 520px">
      <h3>Uploaded</h3>
      <% if (!rows.length) { %><p>No files yet.</p><% } else { %>
      <table>
        <tr><th>When</th><th>By</th><th>Kind</th><th>Note</th><th>Open</th><th>Reviewed</th><th>Action</th></tr>
        <% rows.forEach(f=>{ %>
          <tr>
            <td><%= f.created_at %></td>
            <td><%= f.uploader_id===a.patient_id?'Patient':'Doctor' %></td>
            <td><%= f.kind %></td>
            <td><%= f.note||'' %></td>
            <td><a href="<%= f.filepath %>" target="_blank">Open</a></td>
            <td><%= f.reviewed?'Yes':'No' %></td>
            <td>
              <% if (user && (user.role==='admin'||user.id===a.doctor_id) && !f.reviewed) { %>
                <form method="post" action="/appointments/<%= a.id %>/files/<%= f.id %>/review" style="display:inline">
                  <%- include('partials/csrf') %>
                  <button>Mark reviewed</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </table>
      <% } %>
    </div>
  </div>
  <p><a href="/patient/dashboard">Back</a></p>
</div>
<%- include('_footer') %>
</body></html>
