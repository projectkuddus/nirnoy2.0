<%- include('partials/header') %>

<div class="page-container">
  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success">
      <strong>Done:</strong>
      <span><%= success %></span>
    </div>
  <% } %>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <strong>Cannot complete action:</strong>
      <span><%= error %></span>
    </div>
  <% } %>

  <div class="page-header-row">
    <div>
      <h1 class="page-title">My visits</h1>
      <p class="page-subtitle">
        All appointments you have booked through Nirnoy.
      </p>
    </div>
  </div>

  <!-- Upcoming visits -->
  <section class="dashboard-section">
    <div class="card">
      <div class="card-inner">
        <div class="section-header">
          <h2 class="section-title">Upcoming visits</h2>
        </div>

        <% if (!upcomingAppointments || !upcomingAppointments.length) { %>
          <p class="muted">
            No upcoming visits yet.
          </p>
        <% } else { %>
          <div class="visit-list">
            <% upcomingAppointments.forEach(function (appt) { %>
              <div class="visit-row">
                <div class="visit-main">
                  <div class="visit-title">
                    <strong><%= appt.doctor_name || 'Doctor' %></strong>
                  </div>

                  <div class="visit-meta">
                    <%= appt.doctor_specialty || 'Specialty not specified' %>
                    <% if (appt.doctor_area) { %>
                      · <%= appt.doctor_area %>
                    <% } %>
                  </div>

                  <div class="visit-meta">
                    <% if (appt.clinic_name) { %>
                      <%= appt.clinic_name %>
                      <% if (appt.clinic_area) { %>
                        · <%= appt.clinic_area %>
                      <% } %>
                    <% } %>
                  </div>

                  <div class="visit-meta">
                    Date: <%= appt.appt_date %> · Time: <%= appt.slot_time || 'Not set' %>
                  </div>

                  <div class="visit-status-pill">
                    <span class="status-chip status-scheduled">
                      <%= (appt.status || 'scheduled').charAt(0).toUpperCase() + (appt.status || 'scheduled').slice(1) %>
                    </span>
                  </div>
                </div>

                <div class="visit-actions">
                  <form
                    action="/patient/appointments/<%= appt.id %>/cancel"
                    method="post"
                    onsubmit="return confirm('Cancel this appointment?');"
                  >
                    <button type="submit" class="btn btn-ghost btn-sm">
                      Cancel
                    </button>
                  </form>

                  <a
                    href="/bookings/new?doctor_id=<%= appt.doctor_id %>"
                    class="btn btn-primary btn-sm"
                  >
                    Book again
                  </a>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Past visits -->
  <section class="dashboard-section">
    <div class="card">
      <div class="card-inner">
        <div class="section-header">
          <h2 class="section-title">Past visits</h2>
        </div>

        <% if (!pastAppointments || !pastAppointments.length) { %>
          <p class="muted">
            No past visits recorded yet.
          </p>
        <% } else { %>
          <div class="visit-list">
            <% pastAppointments.forEach(function (appt) { %>
              <div class="visit-row">
                <div class="visit-main">
                  <div class="visit-title">
                    <strong><%= appt.doctor_name || 'Doctor' %></strong>
                  </div>

                  <div class="visit-meta">
                    <%= appt.doctor_specialty || 'Specialty not specified' %>
                    <% if (appt.doctor_area) { %>
                      · <%= appt.doctor_area %>
                    <% } %>
                  </div>

                  <div class="visit-meta">
                    <% if (appt.clinic_name) { %>
                      <%= appt.clinic_name %>
                      <% if (appt.clinic_area) { %>
                        · <%= appt.clinic_area %>
                      <% } %>
                    <% } %>
                  </div>

                  <div class="visit-meta">
                    Date: <%= appt.appt_date %> · Time: <%= appt.slot_time || 'Not set' %>
                  </div>

                  <div class="visit-status-pill">
                    <%
                      const status = (appt.status || '').toLowerCase();
                      let statusLabel = 'Completed';
                      let statusClass = 'status-completed';
                      if (status === 'cancelled') {
                        statusLabel = 'Cancelled';
                        statusClass = 'status-cancelled';
                      } else if (!status || status === 'scheduled') {
                        statusLabel = 'Scheduled';
                        statusClass = 'status-scheduled';
                      }
                    %>
                    <span class="status-chip <%= statusClass %>">
                      <%= statusLabel %>
                    </span>
                  </div>
                </div>

                <div class="visit-actions">
                  <a
                    href="/doctors/<%= appt.doctor_id %>"
                    class="btn btn-ghost btn-sm"
                  >
                    View doctor
                  </a>

                  <a
                    href="/bookings/new?doctor_id=<%= appt.doctor_id %>"
                    class="btn btn-primary btn-sm"
                  >
                    Book again
                  </a>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </section>
</div>

<%- include('partials/footer') %>
